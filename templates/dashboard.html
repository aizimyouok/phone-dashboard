{% extends "base.html" %}

{% block title %}ëŒ€ì‹œë³´ë“œ - CFC íšŒì„  ë° ìš”ê¸ˆ ê´€ë¦¬ ì‹œìŠ¤í…œ{% endblock %}

{% block content %}
    <!-- PDF ì—…ë¡œë“œ ë° ë°ì´í„° ê´€ë¦¬ -->
    <section class="controls">
        <h3>ğŸ“ PDF ì—…ë¡œë“œ ë° ë°ì´í„° ê´€ë¦¬</h3>
        <div class="filter-row">
            <div class="filter-group">
                <label>ì²­êµ¬ì„œ PDF íŒŒì¼</label>
                <input type="file" id="pdf-file" accept=".pdf">
            </div>
            <button class="btn btn-primary" onclick="uploadPdf()">PDF ì—…ë¡œë“œ ë° ì²˜ë¦¬</button>
            <button class="btn btn-danger" onclick="showDeleteDialog()" style="margin-left: 10px;">ğŸ—‘ï¸ ë°ì´í„° ì‚­ì œ</button>
            <button class="btn btn-secondary" onclick="exportExcel()" style="margin-left: 10px;">ğŸ“¥ Excel ë‚´ë³´ë‚´ê¸°</button>
        </div>
        <div id="upload-status" style="margin-top: 10px;"></div>
    </section>

    <!-- ê¸°ë³¸ í•„í„° -->
    <section class="controls">
        <h3>ğŸ” ê¸°ë³¸ í•„í„°</h3>
        <div class="filter-row">
            <div class="filter-group">
                <label>ì§€ì </label>
                <select id="branch-filter" onchange="applyDashboardFilter()">
                    <option value="all">ì „ì²´ ì§€ì </option>
                </select>
            </div>
            <div class="filter-group">
                <label>ì²­êµ¬ì›”</label>
                <select id="month-filter" onchange="applyDashboardFilter()">
                    <option value="all">ì „ì²´ ì›”</option>
                </select>
            </div>
            <button class="btn btn-secondary" onclick="resetDashboardFilter()">ì´ˆê¸°í™”</button>
        </div>
    </section>

    <!-- ì „ì²´ í˜„í™© KPI -->
    <section class="kpi-container">
        <div class="kpi-card">
            <div class="title">ì´ ìš”ê¸ˆ</div>
            <div class="value" id="kpi-total-cost">...</div>
            <div id="kpi-month" style="font-size: 12px; color: #999; margin-top: 5px;"></div>
        </div>
        <div class="kpi-card">
            <div class="title">ì´ í™œì„± íšŒì„ </div>
            <div class="value" id="kpi-active-lines">...</div>
        </div>
        <div class="kpi-card">
            <div class="title">ê¸°ë³¸ë£Œë§Œ ë°œìƒ íšŒì„ </div>
            <div class="value" id="kpi-basic-lines">...</div>
        </div>
        <div class="kpi-card">
            <div class="title">ë¶€ê°€ì„œë¹„ìŠ¤ë£Œ</div>
            <div class="value" id="kpi-vas-fee">...</div>
        </div>
    </section>

    <!-- ì°¨íŠ¸ ì„¹ì…˜ -->
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px;">
        <!-- ì§€ì ë³„ ìš”ê¸ˆ TOP 5 -->
        <div class="chart-container">
            <h3 style="margin: 0 0 20px 0;">ğŸ“Š ì§€ì ë³„ ìš”ê¸ˆ TOP 5</h3>
            <div style="position: relative; height: 300px; width: 100%;">
                <canvas id="top5Chart"></canvas>
            </div>
        </div>
        
        <!-- ì›”ë³„ ì¶”ì´ ì°¨íŠ¸ -->
        <div class="chart-container">
            <h3 style="margin: 0 0 20px 0;">ğŸ“ˆ ì›”ë³„ ìš”ê¸ˆ ì¶”ì´</h3>
            <div style="position: relative; height: 300px; width: 100%;">
                <canvas id="monthlyTrendChart"></canvas>
            </div>
        </div>
    </div>

    <!-- ê¸°ë³¸ë£Œë§Œ ë°œìƒí•˜ëŠ” íšŒì„  ëª©ë¡ -->
    <section class="table-container">
        <div class="card-header">
            ğŸš¨ ê¸°ë³¸ë£Œë§Œ ë°œìƒí•˜ëŠ” íšŒì„  
            <span id="problem-lines-count"></span>
            <div style="float: right;">
                <button class="btn btn-secondary" onclick="prevPage()" id="prev-btn" disabled style="padding: 5px 10px; font-size: 12px;">ì´ì „</button>
                <span id="page-info" style="margin: 0 10px; font-size: 14px;">1 / 1</span>
                <button class="btn btn-secondary" onclick="nextPage()" id="next-btn" disabled style="padding: 5px 10px; font-size: 12px;">ë‹¤ìŒ</button>
            </div>
        </div>
        <div style="overflow-x: auto;">
            <table id="problem-lines-table">
                <thead>
                    <tr>
                        <th onclick="sortTable(0)" style="cursor: pointer;">ì§€ì ëª… â†•ï¸</th>
                        <th onclick="sortTable(1)" style="cursor: pointer;">ì „í™”ë²ˆí˜¸ â†•ï¸</th>
                        <th onclick="sortTable(2)" style="cursor: pointer;">ì‚¬ìš©ìš”ê¸ˆê³„ â†•ï¸</th>
                        <th onclick="sortTable(3)" style="cursor: pointer;">í• ì¸ì•¡ â†•ï¸</th>
                        <th onclick="sortTable(4)" style="cursor: pointer;">ë¶€ê°€ì„¸ â†•ï¸</th>
                        <th onclick="sortTable(5)" style="cursor: pointer;">ìµœì¢…í•©ê³„ â†•ï¸</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </section>
{% endblock %}

{% block modals %}
    <!-- ì¤‘ë³µ í™•ì¸ ëª¨ë‹¬ -->
    <div id="duplicate-modal" class="modal">
        <div class="modal-content">
            <h3>âš ï¸ ì¤‘ë³µ ë°ì´í„° ë°œê²¬</h3>
            <p id="duplicate-message"></p>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeDuplicateModal()">ì·¨ì†Œ</button>
                <button class="btn btn-primary" onclick="overwriteData()">ë®ì–´ì“°ê¸°</button>
            </div>
        </div>
    </div>

    <!-- ì‚­ì œ í™•ì¸ ëª¨ë‹¬ -->
    <div id="delete-modal" class="modal">
        <div class="modal-content">
            <h3>ğŸ—‘ï¸ ë°ì´í„° ì‚­ì œ</h3>
            <p>ì‚­ì œí•  ì²­êµ¬ì›”ì„ ì„ íƒí•´ì£¼ì„¸ìš”:</p>
            <select id="delete-month-select" style="width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px;">
                <option value="">ì²­êµ¬ì›” ì„ íƒ...</option>
            </select>
            <p style="color: #dc3545; font-size: 14px;">âš ï¸ ì‚­ì œëœ ë°ì´í„°ëŠ” ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤!</p>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeDeleteModal()">ì·¨ì†Œ</button>
                <button class="btn btn-danger" onclick="deleteData()">ì‚­ì œ</button>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script>
    let currentUploadData = null;
    let top5Chart = null;
    let monthlyTrendChart = null;
    let allProblemLines = [];
    let currentPage = 1;
    let itemsPerPage = 30;
    let sortColumn = 0;
    let sortAscending = true;
    let currentFilter = { branch: 'all', month: 'all' };

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
    document.addEventListener('DOMContentLoaded', function() {
        loadDashboardData();
        loadFilterOptions();
    });

    // í•„í„° ì˜µì…˜ ë¡œë“œ
    async function loadFilterOptions() {
        try {
            // ì§€ì  ëª©ë¡ ë¡œë“œ
            const branchResponse = await fetch(`${API_BASE}/api/branches`);
            const branches = await branchResponse.json();
            
            const branchSelect = document.getElementById('branch-filter');
            branches.forEach(branch => {
                const option = document.createElement('option');
                option.value = branch;
                option.textContent = branch;
                branchSelect.appendChild(option);
            });

            // ì›” ëª©ë¡ ë¡œë“œ
            const monthResponse = await fetch(`${API_BASE}/api/months`);
            const months = await monthResponse.json();
            
            const monthSelect = document.getElementById('month-filter');
            months.forEach(month => {
                const option = document.createElement('option');
                option.value = month;
                option.textContent = month;
                monthSelect.appendChild(option);
            });

            // ê¸°ë³¸ê°’ ì„¤ì •: ìµœì‹  ì›”
            if (months.length > 0) {
                monthSelect.value = months[0];
                currentFilter.month = months[0];
            }
            
        } catch (error) {
            console.error('í•„í„° ì˜µì…˜ ë¡œë“œ ì‹¤íŒ¨:', error);
        }
    }

    // ëŒ€ì‹œë³´ë“œ ë°ì´í„° ë¡œë“œ
    async function loadDashboardData() {
        try {
            const params = new URLSearchParams();
            if (currentFilter.branch !== 'all') params.append('branch', currentFilter.branch);
            if (currentFilter.month !== 'all') params.append('month', currentFilter.month);
            
            const response = await fetch(`${API_BASE}/api/dashboard?${params}`);
            const data = await response.json();
            
            if (data.error) {
                showError(data.error);
                return;
            }

            updateKPI(data.kpi);
            allProblemLines = data.problemLines || [];
            updateProblemLinesTable();
            updateTop5Chart(data.top5Branches);
            updateMonthlyTrendChart(data.monthlyTrend);
            
        } catch (error) {
            showError('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
        }
    }

    // í•„í„° ì ìš©
    function applyDashboardFilter() {
        const branchSelect = document.getElementById('branch-filter');
        const monthSelect = document.getElementById('month-filter');
        
        currentFilter = {
            branch: branchSelect.value,
            month: monthSelect.value
        };
        
        currentPage = 1;
        loadDashboardData();
    }

    // í•„í„° ì´ˆê¸°í™”
    function resetDashboardFilter() {
        document.getElementById('branch-filter').value = 'all';
        document.getElementById('month-filter').value = 'all';
        currentFilter = { branch: 'all', month: 'all' };
        currentPage = 1;
        loadDashboardData();
    }

    // KPI ì—…ë°ì´íŠ¸
    function updateKPI(kpi) {
        document.getElementById('kpi-month').textContent = `ê¸°ì¤€ ì›”: ${kpi.latestMonth}`;
        document.getElementById('kpi-total-cost').textContent = formatCurrency(kpi.totalCost);
        document.getElementById('kpi-active-lines').textContent = `${kpi.activeLines} ê°œ`;
        document.getElementById('kpi-basic-lines').textContent = `${kpi.basicFeeOnlyLines} ê°œ`;
        document.getElementById('kpi-vas-fee').textContent = formatCurrency(kpi.totalVasFee);
    }

    // ë¬¸ì œ íšŒì„  í…Œì´ë¸” ì—…ë°ì´íŠ¸ (í˜ì´ì§€ë„¤ì´ì…˜ ë° ì •ë ¬ í¬í•¨)
    function updateProblemLinesTable() {
        const tbody = document.querySelector('#problem-lines-table tbody');
        tbody.innerHTML = '';
        
        if (allProblemLines.length === 0) {
            const row = tbody.insertRow();
            const cell = row.insertCell(0);
            cell.colSpan = 6;
            cell.textContent = 'ê¸°ë³¸ë£Œë§Œ ë°œìƒí•˜ëŠ” íšŒì„ ì´ ì—†ìŠµë‹ˆë‹¤. ğŸ‘';
            cell.style.textAlign = 'center';
            cell.style.color = '#28a745';
            document.getElementById('problem-lines-count').textContent = '';
            document.getElementById('page-info').textContent = '0 / 0';
            return;
        }

        // ì •ë ¬ ì ìš©
        const sortedLines = [...allProblemLines].sort((a, b) => {
            let aVal = a[sortColumn];
            let bVal = b[sortColumn];
            
            // ìˆ«ìì¸ ê²½ìš° ìˆ«ìë¡œ ë¹„êµ
            if (typeof aVal === 'number' && typeof bVal === 'number') {
                return sortAscending ? aVal - bVal : bVal - aVal;
            }
            
            // ë¬¸ìì—´ì¸ ê²½ìš° ë¬¸ìì—´ë¡œ ë¹„êµ
            aVal = String(aVal).toLowerCase();
            bVal = String(bVal).toLowerCase();
            
            if (aVal < bVal) return sortAscending ? -1 : 1;
            if (aVal > bVal) return sortAscending ? 1 : -1;
            return 0;
        });

        // í˜ì´ì§€ë„¤ì´ì…˜ ê³„ì‚°
        const totalPages = Math.ceil(sortedLines.length / itemsPerPage);
        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        const pageData = sortedLines.slice(startIndex, endIndex);
        
        // í…Œì´ë¸” ë Œë”ë§
        pageData.forEach(line => {
            const row = tbody.insertRow();
            row.insertCell(0).textContent = line[0]; // ì§€ì ëª…
            row.insertCell(1).textContent = line[1]; // ì „í™”ë²ˆí˜¸
            row.insertCell(2).textContent = formatCurrency(line[2]); // ì‚¬ìš©ìš”ê¸ˆê³„
            row.insertCell(3).textContent = formatCurrency(line[3]); // í• ì¸ì•¡
            row.insertCell(4).textContent = formatCurrency(line[4]); // ë¶€ê°€ì„¸
            row.insertCell(5).textContent = formatCurrency(line[5]); // ìµœì¢…í•©ê³„
        });
        
        // ì¹´ìš´íŠ¸ ë° í˜ì´ì§€ ì •ë³´ ì—…ë°ì´íŠ¸
        document.getElementById('problem-lines-count').textContent = `(ì´ ${allProblemLines.length}ê°œ)`;
        document.getElementById('page-info').textContent = `${currentPage} / ${totalPages}`;
        
        // í˜ì´ì§€ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
        document.getElementById('prev-btn').disabled = currentPage <= 1;
        document.getElementById('next-btn').disabled = currentPage >= totalPages;
    }

    // í…Œì´ë¸” ì •ë ¬
    function sortTable(columnIndex) {
        if (sortColumn === columnIndex) {
            sortAscending = !sortAscending;
        } else {
            sortColumn = columnIndex;
            sortAscending = true;
        }
        
        // í—¤ë” í™”ì‚´í‘œ ì—…ë°ì´íŠ¸
        const headers = document.querySelectorAll('#problem-lines-table th');
        headers.forEach((th, index) => {
            if (index === columnIndex) {
                th.innerHTML = th.innerHTML.split(' ')[0] + (sortAscending ? ' â†‘' : ' â†“');
            } else {
                th.innerHTML = th.innerHTML.split(' ')[0] + ' â†•ï¸';
            }
        });
        
        updateProblemLinesTable();
    }

    // í˜ì´ì§€ ì´ë™
    function nextPage() {
        const totalPages = Math.ceil(allProblemLines.length / itemsPerPage);
        if (currentPage < totalPages) {
            currentPage++;
            updateProblemLinesTable();
        }
    }

    function prevPage() {
        if (currentPage > 1) {
            currentPage--;
            updateProblemLinesTable();
        }
    }

    // ì§€ì ë³„ TOP 5 ì°¨íŠ¸ ì—…ë°ì´íŠ¸
    function updateTop5Chart(chartData) {
        const ctx = document.getElementById('top5Chart').getContext('2d');
        
        if (top5Chart) {
            top5Chart.destroy();
        }
        
        if (chartData.length === 0) {
            const canvas = document.getElementById('top5Chart');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#666';
            ctx.font = '16px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤', canvas.width/2, canvas.height/2);
            return;
        }
        
        top5Chart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: chartData.map(item => item[0]),
                datasets: [{
                    label: 'ìš”ê¸ˆ (ì›)',
                    data: chartData.map(item => item[1]),
                    backgroundColor: [
                        '#667eea',
                        '#764ba2',
                        '#f093fb',
                        '#f5576c',
                        '#4facfe'
                    ],
                    borderWidth: 0,
                    borderRadius: 5
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    datalabels: {
                        display: true,
                        anchor: 'end',
                        align: 'top',
                        formatter: function(value) {
                            return formatNumber(value) + 'ì›';
                        },
                        color: '#333',
                        font: {
                            size: 12,
                            weight: 'bold'
                        }
                    }
                },
                scales: {
                    x: {
                        ticks: {
                            maxRotation: 45,
                            minRotation: 0
                        }
                    },
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return formatNumber(value) + 'ì›';
                            }
                        }
                    }
                },
                layout: {
                    padding: {
                        top: 30,
                        bottom: 10
                    }
                }
            },
            plugins: [ChartDataLabels]
        });
    }

    // ì›”ë³„ ì¶”ì´ ì°¨íŠ¸ ì—…ë°ì´íŠ¸
    function updateMonthlyTrendChart(trendData) {
        const ctx = document.getElementById('monthlyTrendChart').getContext('2d');
        
        if (monthlyTrendChart) {
            monthlyTrendChart.destroy();
        }
        
        if (!trendData || trendData.months.length === 0) {
            const canvas = document.getElementById('monthlyTrendChart');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#666';
            ctx.font = '16px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤', canvas.width/2, canvas.height/2);
            return;
        }
        
        monthlyTrendChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: trendData.months,
                datasets: [{
                    label: 'ì´ ìš”ê¸ˆ',
                    data: trendData.totalCosts,
                    borderColor: '#667eea',
                    backgroundColor: 'rgba(102, 126, 234, 0.1)',
                    fill: true,
                    tension: 0.3,
                    pointRadius: 6,
                    pointHoverRadius: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    datalabels: {
                        display: true,
                        backgroundColor: 'rgba(255, 255, 255, 0.8)',
                        borderColor: '#667eea',
                        borderRadius: 4,
                        borderWidth: 1,
                        formatter: function(value) {
                            return formatNumber(value) + 'ì›';
                        },
                        color: '#333',
                        font: {
                            size: 10,
                            weight: 'bold'
                        },
                        padding: 4
                    }
                },
                scales: {
                    x: {
                        grid: {
                            display: false
                        }
                    },
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return formatNumber(value) + 'ì›';
                            }
                        }
                    }
                },
                layout: {
                    padding: {
                        top: 30,
                        bottom: 10
                    }
                }
            },
            plugins: [ChartDataLabels]
        });
    }

    // PDF ì—…ë¡œë“œ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
    async function uploadPdf(overwrite = false) {
        const fileInput = document.getElementById('pdf-file');
        
        if (!fileInput.files[0]) {
            showUploadStatus('PDF íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
            return;
        }
        
        const formData = new FormData();
        formData.append('file', fileInput.files[0]);
        if (overwrite) {
            formData.append('overwrite', 'true');
        }
        
        showUploadStatus('PDF ì²˜ë¦¬ ì¤‘...', 'loading');
        
        try {
            const response = await fetch(`${API_BASE}/api/upload`, {
                method: 'POST',
                body: formData
            });
            
            const result = await response.json();
            
            // ë””ë²„ê¹…: íŒŒì‹± ê²°ê³¼ë¥¼ ì½˜ì†”ì— ì¶œë ¥
            console.log('=== PDF íŒŒì‹± ê²°ê³¼ ===');
            console.log('ì „ì²´ ì‘ë‹µ:', result);
            if (result.parsed_phones) {
                console.log('íŒŒì‹±ëœ ì „í™”ë²ˆí˜¸ ëª©ë¡:', result.parsed_phones);
                console.log('íŒŒì‹±ëœ ì „í™”ë²ˆí˜¸ ê°œìˆ˜:', result.parsed_phones.length);
            }
            if (result.debug_info) {
                console.log('=== PDF í…ìŠ¤íŠ¸ ì¶”ì¶œ ë””ë²„ê¹… ===');
                console.log('í…ìŠ¤íŠ¸ ê¸¸ì´:', result.debug_info.text_length);
                console.log('** íŒ¨í„´ í¬í•¨ ì—¬ë¶€:', result.debug_info.contains_star_star);
                console.log('02)** íŒ¨í„´ í¬í•¨ ì—¬ë¶€:', result.debug_info.contains_02);
                console.log('080)** íŒ¨í„´ í¬í•¨ ì—¬ë¶€:', result.debug_info.contains_080);
                
                console.log('=== íŒ¨í„´ë³„ ë§¤ì¹­ ê°œìˆ˜ ===');
                console.log('ì „êµ­ëŒ€í‘œë²ˆí˜¸:', result.debug_info.pattern_matches?.ì „êµ­ëŒ€í‘œë²ˆí˜¸ || 0, 'ê°œ');
                console.log('070ë²ˆí˜¸:', result.debug_info.pattern_matches?.['070ë²ˆí˜¸'] || 0, 'ê°œ');
                console.log('02ë²ˆí˜¸:', result.debug_info.pattern_matches?.['02ë²ˆí˜¸'] || 0, 'ê°œ');
                console.log('080ë²ˆí˜¸:', result.debug_info.pattern_matches?.['080ë²ˆí˜¸'] || 0, 'ê°œ');
                
                console.log('=== íŒ¨í„´ë³„ íŒŒì‹± ì„±ê³µë¥  ===');
                if (result.debug_info.pattern_parsing_stats) {
                    Object.entries(result.debug_info.pattern_parsing_stats).forEach(([pattern, stats]) => {
                        const successRate = stats.found > 0 ? Math.round((stats.parsed / stats.found) * 100) : 0;
                        console.log(`${pattern}: ${stats.parsed}/${stats.found}ê°œ íŒŒì‹± ì„±ê³µ (${successRate}%)`);
                        
                        if (stats.parsed === 0 && stats.found > 0) {
                            console.warn(`âš ï¸ ${pattern} íŒ¨í„´ì€ ë°œê²¬ë˜ì—ˆì§€ë§Œ íŒŒì‹±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤!`);
                        }
                    });
                }
                
                console.log('=== ì‹¤ì œ ë§¤ì¹­ëœ ì „í™”ë²ˆí˜¸ ìƒ˜í”Œ ===');
                if (result.debug_info.sample_matches) {
                    console.log('ì „êµ­ëŒ€í‘œë²ˆí˜¸ ìƒ˜í”Œ:', result.debug_info.sample_matches.ì „êµ­ëŒ€í‘œë²ˆí˜¸);
                    console.log('070ë²ˆí˜¸ ìƒ˜í”Œ:', result.debug_info.sample_matches['070ë²ˆí˜¸']);
                    console.log('02ë²ˆí˜¸ ìƒ˜í”Œ:', result.debug_info.sample_matches['02ë²ˆí˜¸']);
                    console.log('080ë²ˆí˜¸ ìƒ˜í”Œ:', result.debug_info.sample_matches['080ë²ˆí˜¸']);
                }
                
                console.log('=== íŒ¨í„´ë³„ ì£¼ë³€ í…ìŠ¤íŠ¸ ìƒ˜í”Œ (ë””ë²„ê¹…ìš©) ===');
                if (result.debug_info.sample_text_around_patterns) {
                    Object.entries(result.debug_info.sample_text_around_patterns).forEach(([pattern, text]) => {
                        console.log(`${pattern} ì£¼ë³€ í…ìŠ¤íŠ¸:`, text.substring(0, 500) + '...');
                    });
                }
                
                console.log('PDF í…ìŠ¤íŠ¸ ë¯¸ë¦¬ë³´ê¸° (ì²˜ìŒ 3000ë¬¸ì):');
                console.log(result.debug_info.text_preview);
            }
            console.log('==================');
            
            if (result.duplicate && !overwrite) {
                currentUploadData = { fileInput, formData };
                showDuplicateModal(result);
            } else if (result.success) {
                showUploadStatus(`âœ… ì„±ê³µ! ${result.message} (${result.billing_month})`, 'success');
                setTimeout(() => {
                    loadDashboardData();
                    loadMonthsForDelete();
                }, 1000);
            } else {
                showUploadStatus(`âŒ ${result.error}`, 'error');
            }
            
        } catch (error) {
            showUploadStatus(`âŒ ì—…ë¡œë“œ ì‹¤íŒ¨: ${error.message}`, 'error');
        }
    }

    // ë‚˜ë¨¸ì§€ í•¨ìˆ˜ë“¤ì€ ê¸°ì¡´ê³¼ ë™ì¼...
    function showUploadStatus(message, type) {
        const statusDiv = document.getElementById('upload-status');
        statusDiv.textContent = message;
        statusDiv.className = type;
    }

    function showDuplicateModal(result) {
        const modal = document.getElementById('duplicate-modal');
        const message = document.getElementById('duplicate-message');
        
        let duplicateDetailsHtml = '';
        if (result.duplicate_details && result.duplicate_details.length > 0) {
            duplicateDetailsHtml = '<br><br><strong>ì¤‘ë³µëœ íšŒì„  ì •ë³´:</strong><br>';
            result.duplicate_details.forEach(detail => {
                duplicateDetailsHtml += `â€¢ ${detail.phone} (${detail.existing_branch}) - ${formatCurrency(detail.amount)}<br>`;
            });
            if (result.existing_count > result.duplicate_details.length) {
                duplicateDetailsHtml += `â€¢ ê·¸ ì™¸ ${result.existing_count - result.duplicate_details.length}ê±´ ë”...<br>`;
            }
        }
        
        message.innerHTML = `
            <strong>${result.billing_month}</strong> ì²­êµ¬ì›”ì—ì„œ ì •í™•íˆ ì¼ì¹˜í•˜ëŠ” ë°ì´í„°ê°€ <strong>${result.existing_count}ê±´</strong> ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤.<br>
            (ì „í™”ë²ˆí˜¸ + ìµœì¢…í•©ê³„ ê¸ˆì•¡ì´ ë™ì¼í•œ ë°ì´í„°)<br>
            ìƒˆë¡œ ì—…ë¡œë“œí•  ë°ì´í„°ëŠ” <strong>${result.new_data_count}ê±´</strong>ì…ë‹ˆë‹¤.
            ${duplicateDetailsHtml}<br>
            ì¤‘ë³µëœ ë°ì´í„°ë§Œ ì‚­ì œí•˜ê³  ìƒˆ ë°ì´í„°ë¡œ ë®ì–´ì“°ì‹œê² ìŠµë‹ˆê¹Œ?
        `;
        
        modal.style.display = 'block';
    }

    function closeDuplicateModal() {
        document.getElementById('duplicate-modal').style.display = 'none';
        showUploadStatus('ì—…ë¡œë“œê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.', 'error');
    }

    async function overwriteData() {
        document.getElementById('duplicate-modal').style.display = 'none';
        
        if (!currentUploadData) return;
        
        const formData = currentUploadData.formData;
        formData.set('overwrite', 'true');
        
        showUploadStatus('ê¸°ì¡´ ë°ì´í„° ë®ì–´ì“°ëŠ” ì¤‘...', 'loading');
        
        try {
            const response = await fetch(`${API_BASE}/api/upload`, {
                method: 'POST',
                body: formData
            });
            
            const result = await response.json();
            
            if (result.success) {
                showUploadStatus(`âœ… ë®ì–´ì“°ê¸° ì„±ê³µ! ${result.message} (${result.billing_month})`, 'success');
                setTimeout(() => {
                    loadDashboardData();
                    loadMonthsForDelete();
                }, 1000);
            } else {
                showUploadStatus(`âŒ ${result.error}`, 'error');
            }
            
        } catch (error) {
            showUploadStatus(`âŒ ë®ì–´ì“°ê¸° ì‹¤íŒ¨: ${error.message}`, 'error');
        }
    }

    async function showDeleteDialog() {
        await loadMonthsForDelete();
        document.getElementById('delete-modal').style.display = 'block';
    }

    function closeDeleteModal() {
        document.getElementById('delete-modal').style.display = 'none';
    }

    async function loadMonthsForDelete() {
        try {
            const response = await fetch(`${API_BASE}/api/months`);
            const months = await response.json();
            
            const select = document.getElementById('delete-month-select');
            select.innerHTML = '<option value="">ì²­êµ¬ì›” ì„ íƒ...</option>';
            
            months.forEach(month => {
                const option = document.createElement('option');
                option.value = month;
                option.textContent = month;
                select.appendChild(option);
            });
            
        } catch (error) {
            console.error('ì›” ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
        }
    }

    async function deleteData() {
        const select = document.getElementById('delete-month-select');
        const selectedMonth = select.value;
        
        if (!selectedMonth) {
            alert('ì‚­ì œí•  ì²­êµ¬ì›”ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
            return;
        }
        
        if (!confirm(`ì •ë§ë¡œ ${selectedMonth} ì²­êµ¬ì›” ë°ì´í„°ë¥¼ ëª¨ë‘ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì‚­ì œëœ ë°ì´í„°ëŠ” ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤!`)) {
            return;
        }
        
        closeDeleteModal();
        showUploadStatus(`${selectedMonth} ë°ì´í„° ì‚­ì œ ì¤‘...`, 'loading');
        
        try {
            const response = await fetch(`${API_BASE}/api/delete`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    billing_month: selectedMonth
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                showUploadStatus(`âœ… ${result.message}`, 'success');
                setTimeout(() => {
                    loadDashboardData();
                }, 1000);
            } else {
                showUploadStatus(`âŒ ${result.error}`, 'error');
            }
            
        } catch (error) {
            showUploadStatus(`âŒ ì‚­ì œ ì‹¤íŒ¨: ${error.message}`, 'error');
        }
    }

    async function exportExcel() {
        try {
            showUploadStatus('Excel íŒŒì¼ ìƒì„± ì¤‘...', 'loading');
            
            const response = await fetch(`${API_BASE}/api/export/excel`);
            
            if (!response.ok) {
                throw new Error('Excel ë‚´ë³´ë‚´ê¸° ì‹¤íŒ¨');
            }
            
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ì „í™”ìš”ê¸ˆ_ë°ì´í„°_${new Date().toISOString().slice(0,10)}.xlsx`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            
            showUploadStatus('âœ… Excel íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ!', 'success');
            
        } catch (error) {
            showUploadStatus(`âŒ Excel ë‚´ë³´ë‚´ê¸° ì‹¤íŒ¨: ${error.message}`, 'error');
        }
    }
</script>

<!-- Chart.js DataLabels í”ŒëŸ¬ê·¸ì¸ ì¶”ê°€ -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-datalabels/2.2.0/chartjs-plugin-datalabels.min.js"></script>
{% endblock %}