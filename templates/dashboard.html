{% extends "base.html" %}

{% block title %}ëŒ€ì‹œë³´ë“œ - ì „í™”ìš”ê¸ˆ ê´€ë¦¬ ì‹œìŠ¤í…œ{% endblock %}

{% block content %}
    <!-- PDF ì—…ë¡œë“œ ë° ë°ì´í„° ê´€ë¦¬ -->
    <section class="controls">
        <h3>ğŸ“ PDF ì—…ë¡œë“œ ë° ë°ì´í„° ê´€ë¦¬</h3>
        <div class="filter-row">
            <div class="filter-group">
                <label>ì²­êµ¬ì„œ PDF íŒŒì¼</label>
                <input type="file" id="pdf-file" accept=".pdf">
            </div>
            <button class="btn btn-primary" onclick="uploadPdf()">PDF ì—…ë¡œë“œ ë° ì²˜ë¦¬</button>
            <button class="btn btn-danger" onclick="showDeleteDialog()" style="margin-left: 10px;">ğŸ—‘ï¸ ë°ì´í„° ì‚­ì œ</button>
        </div>
        <div id="upload-status" style="margin-top: 10px;"></div>
    </section>

    <!-- ì „ì²´ í˜„í™© KPI -->
    <section class="kpi-container">
        <div class="kpi-card">
            <div class="title">ì´ ìš”ê¸ˆ</div>
            <div class="value" id="kpi-total-cost">...</div>
            <div id="kpi-month" style="font-size: 12px; color: #999; margin-top: 5px;"></div>
        </div>
        <div class="kpi-card">
            <div class="title">ì´ í™œì„± íšŒì„ </div>
            <div class="value" id="kpi-active-lines">...</div>
        </div>
        <div class="kpi-card">
            <div class="title">ê¸°ë³¸ë£Œë§Œ ë°œìƒ íšŒì„ </div>
            <div class="value" id="kpi-basic-lines">...</div>
        </div>
        <div class="kpi-card">
            <div class="title">ë¶€ê°€ì„œë¹„ìŠ¤ë£Œ</div>
            <div class="value" id="kpi-vas-fee">...</div>
        </div>
    </section>

    <!-- ì°¨íŠ¸ ì„¹ì…˜ -->
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px;">
        <!-- ì§€ì ë³„ ìš”ê¸ˆ TOP 5 -->
        <div class="chart-container">
            <h3 style="margin: 0 0 20px 0;">ğŸ“Š ì§€ì ë³„ ìš”ê¸ˆ TOP 5</h3>
            <div style="position: relative; height: 300px; width: 100%;">
                <canvas id="top5Chart"></canvas>
            </div>
        </div>
        
        <!-- ë¹ ë¥¸ ì•¡ì„¸ìŠ¤ -->
        <div class="chart-container">
            <h3 style="margin: 0 0 20px 0;">ğŸš€ ë¹ ë¥¸ ì•¡ì„¸ìŠ¤</h3>
            <div style="display: grid; gap: 15px;">
                <a href="/search" class="btn btn-primary" style="padding: 20px; text-decoration: none;">
                    ğŸ” ìƒì„¸ ê²€ìƒ‰<br>
                    <small style="opacity: 0.8;">ì§€ì ë³„, ì›”ë³„ ìƒì„¸ ê²€ìƒ‰</small>
                </a>
                <a href="/analytics" class="btn btn-success" style="padding: 20px; text-decoration: none;">
                    ğŸ“Š ë¶„ì„ ë¦¬í¬íŠ¸<br>
                    <small style="opacity: 0.8;">íŠ¸ë Œë“œ ë¶„ì„ ë° ë¦¬í¬íŠ¸</small>
                </a>
                <button class="btn btn-secondary" onclick="exportExcel()" style="padding: 20px;">
                    ğŸ“¥ Excel ë‚´ë³´ë‚´ê¸°<br>
                    <small style="opacity: 0.8;">ì „ì²´ ë°ì´í„° ë‹¤ìš´ë¡œë“œ</small>
                </button>
            </div>
        </div>
    </div>

    <!-- ë¬¸ì œ íšŒì„  ëª©ë¡ -->
    <section class="table-container">
        <div class="card-header">ğŸš¨ ë¬¸ì œ íšŒì„  ëª©ë¡ (ê¸°ë³¸ë£Œë§Œ ë°œìƒ)</div>
        <div style="overflow-x: auto;">
            <table id="problem-lines-table">
                <thead>
                    <tr>
                        <th>ì§€ì ëª…</th>
                        <th>ì „í™”ë²ˆí˜¸</th>
                        <th>ìµœì¢…í•©ê³„</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </section>
{% endblock %}

{% block modals %}
    <!-- ì¤‘ë³µ í™•ì¸ ëª¨ë‹¬ -->
    <div id="duplicate-modal" class="modal">
        <div class="modal-content">
            <h3>âš ï¸ ì¤‘ë³µ ë°ì´í„° ë°œê²¬</h3>
            <p id="duplicate-message"></p>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeDuplicateModal()">ì·¨ì†Œ</button>
                <button class="btn btn-primary" onclick="overwriteData()">ë®ì–´ì“°ê¸°</button>
            </div>
        </div>
    </div>

    <!-- ì‚­ì œ í™•ì¸ ëª¨ë‹¬ -->
    <div id="delete-modal" class="modal">
        <div class="modal-content">
            <h3>ğŸ—‘ï¸ ë°ì´í„° ì‚­ì œ</h3>
            <p>ì‚­ì œí•  ì²­êµ¬ì›”ì„ ì„ íƒí•´ì£¼ì„¸ìš”:</p>
            <select id="delete-month-select" style="width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px;">
                <option value="">ì²­êµ¬ì›” ì„ íƒ...</option>
            </select>
            <p style="color: #dc3545; font-size: 14px;">âš ï¸ ì‚­ì œëœ ë°ì´í„°ëŠ” ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤!</p>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeDeleteModal()">ì·¨ì†Œ</button>
                <button class="btn btn-danger" onclick="deleteData()">ì‚­ì œ</button>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script>
    let currentUploadData = null;
    let top5Chart = null;

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
    document.addEventListener('DOMContentLoaded', function() {
        loadDashboardData();
    });

    // ëŒ€ì‹œë³´ë“œ ë°ì´í„° ë¡œë“œ
    async function loadDashboardData() {
        try {
            const response = await fetch(`${API_BASE}/api/dashboard`);
            const data = await response.json();
            
            if (data.error) {
                showError(data.error);
                return;
            }

            updateKPI(data.kpi);
            updateProblemLines(data.problemLines);
            updateChart(data.top5Branches);
            
        } catch (error) {
            showError('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
        }
    }

    // KPI ì—…ë°ì´íŠ¸
    function updateKPI(kpi) {
        document.getElementById('kpi-month').textContent = `ê¸°ì¤€ ì›”: ${kpi.latestMonth}`;
        document.getElementById('kpi-total-cost').textContent = formatCurrency(kpi.totalCost);
        document.getElementById('kpi-active-lines').textContent = `${kpi.activeLines} ê°œ`;
        document.getElementById('kpi-basic-lines').textContent = `${kpi.basicFeeOnlyLines} ê°œ`;
        document.getElementById('kpi-vas-fee').textContent = formatCurrency(kpi.totalVasFee);
    }

    // ë¬¸ì œ íšŒì„  í…Œì´ë¸” ì—…ë°ì´íŠ¸
    function updateProblemLines(problemLines) {
        const tbody = document.querySelector('#problem-lines-table tbody');
        tbody.innerHTML = '';
        
        if (problemLines.length === 0) {
            const row = tbody.insertRow();
            const cell = row.insertCell(0);
            cell.colSpan = 3;
            cell.textContent = 'ë¬¸ì œ íšŒì„ ì´ ì—†ìŠµë‹ˆë‹¤. ğŸ‘';
            cell.style.textAlign = 'center';
            cell.style.color = '#28a745';
            return;
        }
        
        problemLines.forEach(line => {
            const row = tbody.insertRow();
            row.insertCell(0).textContent = line[0];
            row.insertCell(1).textContent = line[1];
            row.insertCell(2).textContent = formatCurrency(line[2]);
        });
    }

    // ì°¨íŠ¸ ì—…ë°ì´íŠ¸
    function updateChart(chartData) {
        const ctx = document.getElementById('top5Chart').getContext('2d');
        
        if (top5Chart) {
            top5Chart.destroy();
        }
        
        if (chartData.length === 0) {
            // ë°ì´í„°ê°€ ì—†ì„ ë•Œ ë©”ì‹œì§€ í‘œì‹œ
            const canvas = document.getElementById('top5Chart');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#666';
            ctx.font = '16px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤', canvas.width/2, canvas.height/2);
            return;
        }
        
        top5Chart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: chartData.map(item => item[0]),
                datasets: [{
                    label: 'ìš”ê¸ˆ (ì›)',
                    data: chartData.map(item => item[1]),
                    backgroundColor: [
                        '#667eea',
                        '#764ba2',
                        '#f093fb',
                        '#f5576c',
                        '#4facfe'
                    ],
                    borderWidth: 0,
                    borderRadius: 5
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    x: {
                        ticks: {
                            maxRotation: 45,
                            minRotation: 0
                        }
                    },
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return formatNumber(value) + 'ì›';
                            }
                        }
                    }
                },
                layout: {
                    padding: {
                        top: 10,
                        bottom: 10
                    }
                }
            }
        });
    }

    // PDF ì—…ë¡œë“œ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
    async function uploadPdf(overwrite = false) {
        const fileInput = document.getElementById('pdf-file');
        
        if (!fileInput.files[0]) {
            showUploadStatus('PDF íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
            return;
        }
        
        const formData = new FormData();
        formData.append('file', fileInput.files[0]);
        if (overwrite) {
            formData.append('overwrite', 'true');
        }
        
        showUploadStatus('PDF ì²˜ë¦¬ ì¤‘...', 'loading');
        
        try {
            const response = await fetch(`${API_BASE}/api/upload`, {
                method: 'POST',
                body: formData
            });
            
            const result = await response.json();
            
            if (result.duplicate && !overwrite) {
                currentUploadData = { fileInput, formData };
                showDuplicateModal(result);
            } else if (result.success) {
                showUploadStatus(`âœ… ì„±ê³µ! ${result.message} (${result.billing_month})`, 'success');
                setTimeout(() => {
                    loadDashboardData();
                    loadMonthsForDelete();
                }, 1000);
            } else {
                showUploadStatus(`âŒ ${result.error}`, 'error');
            }
            
        } catch (error) {
            showUploadStatus(`âŒ ì—…ë¡œë“œ ì‹¤íŒ¨: ${error.message}`, 'error');
        }
    }

    // ë‚˜ë¨¸ì§€ í•¨ìˆ˜ë“¤ì€ ê¸°ì¡´ê³¼ ë™ì¼...
    function showUploadStatus(message, type) {
        const statusDiv = document.getElementById('upload-status');
        statusDiv.textContent = message;
        statusDiv.className = type;
    }

    function showDuplicateModal(result) {
        const modal = document.getElementById('duplicate-modal');
        const message = document.getElementById('duplicate-message');
        
        message.innerHTML = `
            <strong>${result.billing_month}</strong> ì²­êµ¬ì›” ë°ì´í„°ê°€ ì´ë¯¸ <strong>${result.existing_count}ê±´</strong> ì¡´ì¬í•©ë‹ˆë‹¤.<br>
            ìƒˆë¡œ ì—…ë¡œë“œí•  ë°ì´í„°ëŠ” <strong>${result.new_data_count}ê±´</strong>ì…ë‹ˆë‹¤.<br><br>
            ê¸°ì¡´ ë°ì´í„°ë¥¼ ì‚­ì œí•˜ê³  ìƒˆ ë°ì´í„°ë¡œ ë®ì–´ì“°ì‹œê² ìŠµë‹ˆê¹Œ?
        `;
        
        modal.style.display = 'block';
    }

    function closeDuplicateModal() {
        document.getElementById('duplicate-modal').style.display = 'none';
        showUploadStatus('ì—…ë¡œë“œê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.', 'error');
    }

    async function overwriteData() {
        document.getElementById('duplicate-modal').style.display = 'none';
        
        if (!currentUploadData) return;
        
        const formData = currentUploadData.formData;
        formData.set('overwrite', 'true');
        
        showUploadStatus('ê¸°ì¡´ ë°ì´í„° ë®ì–´ì“°ëŠ” ì¤‘...', 'loading');
        
        try {
            const response = await fetch(`${API_BASE}/api/upload`, {
                method: 'POST',
                body: formData
            });
            
            const result = await response.json();
            
            if (result.success) {
                showUploadStatus(`âœ… ë®ì–´ì“°ê¸° ì„±ê³µ! ${result.message} (${result.billing_month})`, 'success');
                setTimeout(() => {
                    loadDashboardData();
                    loadMonthsForDelete();
                }, 1000);
            } else {
                showUploadStatus(`âŒ ${result.error}`, 'error');
            }
            
        } catch (error) {
            showUploadStatus(`âŒ ë®ì–´ì“°ê¸° ì‹¤íŒ¨: ${error.message}`, 'error');
        }
    }

    async function showDeleteDialog() {
        await loadMonthsForDelete();
        document.getElementById('delete-modal').style.display = 'block';
    }

    function closeDeleteModal() {
        document.getElementById('delete-modal').style.display = 'none';
    }

    async function loadMonthsForDelete() {
        try {
            const response = await fetch(`${API_BASE}/api/months`);
            const months = await response.json();
            
            const select = document.getElementById('delete-month-select');
            select.innerHTML = '<option value="">ì²­êµ¬ì›” ì„ íƒ...</option>';
            
            months.forEach(month => {
                const option = document.createElement('option');
                option.value = month;
                option.textContent = month;
                select.appendChild(option);
            });
            
        } catch (error) {
            console.error('ì›” ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
        }
    }

    async function deleteData() {
        const select = document.getElementById('delete-month-select');
        const selectedMonth = select.value;
        
        if (!selectedMonth) {
            alert('ì‚­ì œí•  ì²­êµ¬ì›”ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
            return;
        }
        
        if (!confirm(`ì •ë§ë¡œ ${selectedMonth} ì²­êµ¬ì›” ë°ì´í„°ë¥¼ ëª¨ë‘ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì‚­ì œëœ ë°ì´í„°ëŠ” ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤!`)) {
            return;
        }
        
        closeDeleteModal();
        showUploadStatus(`${selectedMonth} ë°ì´í„° ì‚­ì œ ì¤‘...`, 'loading');
        
        try {
            const response = await fetch(`${API_BASE}/api/delete`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    billing_month: selectedMonth
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                showUploadStatus(`âœ… ${result.message}`, 'success');
                setTimeout(() => {
                    loadDashboardData();
                }, 1000);
            } else {
                showUploadStatus(`âŒ ${result.error}`, 'error');
            }
            
        } catch (error) {
            showUploadStatus(`âŒ ì‚­ì œ ì‹¤íŒ¨: ${error.message}`, 'error');
        }
    }

    async function exportExcel() {
        try {
            showUploadStatus('Excel íŒŒì¼ ìƒì„± ì¤‘...', 'loading');
            
            const response = await fetch(`${API_BASE}/api/export/excel`);
            
            if (!response.ok) {
                throw new Error('Excel ë‚´ë³´ë‚´ê¸° ì‹¤íŒ¨');
            }
            
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ì „í™”ìš”ê¸ˆ_ë°ì´í„°_${new Date().toISOString().slice(0,10)}.xlsx`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            
            showUploadStatus('âœ… Excel íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ!', 'success');
            
        } catch (error) {
            showUploadStatus(`âŒ Excel ë‚´ë³´ë‚´ê¸° ì‹¤íŒ¨: ${error.message}`, 'error');
        }
    }
</script>
{% endblock %}