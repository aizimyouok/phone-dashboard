{% extends "base.html" %}

{% block title %}ìƒì„¸ ê²€ìƒ‰ - ì „í™”ìš”ê¸ˆ ê´€ë¦¬ ì‹œìŠ¤í…œ{% endblock %}

{% block content %}
    <!-- í†µí•©ê²€ìƒ‰ ë° í•„í„° -->
    <section class="controls">
        <h3>ğŸ” í†µí•©ê²€ìƒ‰ ë° í•„í„°</h3>
        
        <!-- í†µí•©ê²€ìƒ‰ ë°” -->
        <div class="filter-row" style="margin-bottom: 20px;">
            <div class="filter-group" style="flex: 2;">
                <label>ğŸ” í†µí•©ê²€ìƒ‰ (ì§€ì ëª…, ì „í™”ë²ˆí˜¸, ì²­êµ¬ì›”)</label>
                <input type="text" id="unified-search" placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”... (ì˜ˆ: ë³¸ì , 070-1234, 2024-12)">
            </div>
            <button class="btn btn-primary" onclick="doUnifiedSearch()" style="height: 40px; margin-top: 25px;">í†µí•©ê²€ìƒ‰</button>
        </div>
        
        <!-- ìƒì„¸ í•„í„° -->
        <div class="filter-row">
            <div class="filter-group">
                <label>ì§€ì </label>
                <select id="branch-filter">
                    <option value="all">ì „ì²´ ì§€ì </option>
                </select>
            </div>
            <div class="filter-group">
                <label>ì²­êµ¬ì›”</label>
                <select id="month-filter">
                    <option value="all">ì „ì²´ ì›”</option>
                </select>
            </div>
            <div class="filter-group">
                <label>íšŒì„  ìœ í˜•</label>
                <select id="type-filter">
                    <option value="all">ì „ì²´</option>
                    <option value="basic">ê¸°ë³¸ë£Œë§Œ ë°œìƒ</option>
                    <option value="vas">ë¶€ê°€ì„œë¹„ìŠ¤ ì´ìš©</option>
                </select>
            </div>
            <div class="filter-group">
                <label>ì „í™”ë²ˆí˜¸ (ì„ íƒ)</label>
                <input type="text" id="phone-search" placeholder="ì „í™”ë²ˆí˜¸ (ì„ íƒì‚¬í•­)">
            </div>
        </div>
        
        <!-- í•„í„° ë²„íŠ¼ë“¤ -->
        <div class="filter-row" style="justify-content: flex-start; gap: 10px; margin-top: 15px;">
            <button class="btn btn-primary" onclick="applyAdvancedFilters()">ğŸ“Š ê³ ê¸‰í•„í„° ì ìš©</button>
            <button class="btn btn-secondary" onclick="resetAllFilters()">ğŸ”„ ì „ì²´ ì´ˆê¸°í™”</button>
            <button class="btn btn-success" onclick="exportFilteredExcel()" id="export-btn" style="display: none;">ğŸ“¥ í•„í„° ê²°ê³¼ Excel ë‚´ë³´ë‚´ê¸°</button>
        </div>
        
        <div id="search-status" style="margin-top: 10px;"></div>
    </section>

    <!-- í•„í„°ë§ëœ ë°ì´í„° KPI (ê²€ìƒ‰ í›„ í‘œì‹œ) -->
    <section id="filtered-kpi-section" class="kpi-container" style="display: none; margin-bottom: 20px; border: 2px solid #007bff; border-radius: 10px; padding: 15px;">
        <h3 style="margin: 0 0 15px 0; color: #007bff;" id="kpi-title">ğŸ“Š í•„í„°ë§ëœ ë°ì´í„° í†µê³„</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
            <div class="kpi-card">
                <div class="title">í•„í„°ëœ ì´ ìš”ê¸ˆ</div>
                <div class="value" id="filtered-total-cost">...</div>
            </div>
            <div class="kpi-card">
                <div class="title">í•„í„°ëœ íšŒì„  ìˆ˜</div>
                <div class="value" id="filtered-active-lines">...</div>
            </div>
            <div class="kpi-card">
                <div class="title">í‰ê·  ìš”ê¸ˆ</div>
                <div class="value" id="filtered-avg-cost">...</div>
            </div>
            <div class="kpi-card">
                <div class="title">ê¸°ë³¸ë£Œë§Œ ë°œìƒ</div>
                <div class="value" id="filtered-basic-lines">...</div>
            </div>
            <div class="kpi-card">
                <div class="title">ë¶€ê°€ì„œë¹„ìŠ¤ë£Œ</div>
                <div class="value" id="filtered-vas-fee">...</div>
            </div>
        </div>
    </section>

    <!-- ê²€ìƒ‰ ê²°ê³¼ í…Œì´ë¸” -->
    <section class="table-container" id="filtered-data-section" style="display: none;">
        <div class="card-header">
            <span id="table-title">ê²€ìƒ‰ ê²°ê³¼</span>
            <span id="data-count"></span>
            <button class="btn btn-secondary" onclick="toggleTableView()" id="toggle-btn" style="float: right; padding: 5px 10px; font-size: 12px;">ê°„ë‹¨íˆ ë³´ê¸°</button>
        </div>
        <div style="overflow-x: auto;">
            <table id="filtered-data-table">
                <thead>
                    <tr id="table-header">
                        <th>ì²­êµ¬ì›”</th>
                        <th>ì§€ì ëª…</th>
                        <th>ì „í™”ë²ˆí˜¸</th>
                        <th>ê¸°ë³¸ë£Œ</th>
                        <th>ì‹œë‚´í†µí™”ë£Œ</th>
                        <th>ì´ë™í†µí™”ë£Œ</th>
                        <th>070í†µí™”ë£Œ</th>
                        <th>ë¶€ê°€ì„œë¹„ìŠ¤ë£Œ</th>
                        <th>ìµœì¢…í•©ê³„</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </section>
{% endblock %}

{% block extra_js %}
<script>
    let lastSearchResult = null;
    let isDetailedView = true;

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
    document.addEventListener('DOMContentLoaded', function() {
        loadFilterOptions();
        
        // ì—”í„°í‚¤ ì´ë²¤íŠ¸
        document.getElementById('unified-search').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                doUnifiedSearch();
            }
        });
        
        document.getElementById('phone-search').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                applyAdvancedFilters();
            }
        });
    });

    // í•„í„° ì˜µì…˜ ë¡œë“œ
    async function loadFilterOptions() {
        try {
            // ì§€ì  ëª©ë¡ ë¡œë“œ
            const branchResponse = await fetch(`${API_BASE}/api/branches`);
            const branches = await branchResponse.json();
            
            const branchSelect = document.getElementById('branch-filter');
            branchSelect.innerHTML = '<option value="all">ì „ì²´ ì§€ì </option>';
            branches.forEach(branch => {
                const option = document.createElement('option');
                option.value = branch;
                option.textContent = branch;
                branchSelect.appendChild(option);
            });
            
            // ì²­êµ¬ì›” ëª©ë¡ ë¡œë“œ
            const monthResponse = await fetch(`${API_BASE}/api/months`);
            const months = await monthResponse.json();
            
            const monthSelect = document.getElementById('month-filter');
            monthSelect.innerHTML = '<option value="all">ì „ì²´ ì›”</option>';
            months.forEach(month => {
                const option = document.createElement('option');
                option.value = month;
                option.textContent = month;
                monthSelect.appendChild(option);
            });
            
        } catch (error) {
            console.error('í•„í„° ì˜µì…˜ ë¡œë“œ ì‹¤íŒ¨:', error);
        }
    }

    // í†µí•©ê²€ìƒ‰ ì‹¤í–‰
    async function doUnifiedSearch() {
        const searchText = document.getElementById('unified-search').value.trim();
        
        if (!searchText) {
            alert('ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }
        
        try {
            showSearchStatus('ê²€ìƒ‰ ì¤‘...', 'loading');
            
            const response = await fetch(`${API_BASE}/api/search?q=${encodeURIComponent(searchText)}`);
            const result = await response.json();
            
            if (result.error) {
                showSearchStatus(`âŒ ${result.error}`, 'error');
                return;
            }
            
            lastSearchResult = result;
            
            // í•„í„°ë§ëœ KPI ì—…ë°ì´íŠ¸
            updateFilteredKPI(result.kpi, `í†µí•©ê²€ìƒ‰: "${searchText}"`);
            
            // ê²€ìƒ‰ ê²°ê³¼ í‘œì‹œ
            displaySearchResults(result.data, `í†µí•©ê²€ìƒ‰: "${searchText}"`);
            
            showSearchStatus(`âœ… ê²€ìƒ‰ ì™„ë£Œ: ${result.total}ê±´`, 'success');
            
        } catch (error) {
            showSearchStatus(`âŒ ê²€ìƒ‰ ì‹¤íŒ¨: ${error.message}`, 'error');
        }
    }

    // ê³ ê¸‰ í•„í„° ì ìš©
    async function applyAdvancedFilters() {
        const branch = document.getElementById('branch-filter').value;
        const month = document.getElementById('month-filter').value;
        const type = document.getElementById('type-filter').value;
        const phone = document.getElementById('phone-search').value.trim();
        
        // ëª¨ë“  í•„í„°ê°€ ê¸°ë³¸ê°’ì´ë©´ ê²½ê³ 
        if (branch === 'all' && month === 'all' && type === 'all' && !phone) {
            alert('ìµœì†Œ í•˜ë‚˜ì˜ í•„í„°ë¥¼ ì„ íƒí•˜ê±°ë‚˜ ì „í™”ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }
        
        try {
            showSearchStatus('í•„í„° ì ìš© ì¤‘...', 'loading');
            
            const params = new URLSearchParams();
            if (branch !== 'all') params.append('branch', branch);
            if (month !== 'all') params.append('month', month);
            if (type !== 'all') params.append('type', type);
            if (phone) params.append('phone', phone);
            
            const response = await fetch(`${API_BASE}/api/search?${params.toString()}`);
            const result = await response.json();
            
            if (result.error) {
                showSearchStatus(`âŒ ${result.error}`, 'error');
                return;
            }
            
            lastSearchResult = result;
            
            // í•„í„° ì„¤ëª… ìƒì„±
            let filterDesc = [];
            if (branch !== 'all') filterDesc.push(`ì§€ì : ${branch}`);
            if (month !== 'all') filterDesc.push(`ì²­êµ¬ì›”: ${month}`);
            if (type !== 'all') filterDesc.push(`ìœ í˜•: ${type === 'basic' ? 'ê¸°ë³¸ë£Œë§Œ' : 'ë¶€ê°€ì„œë¹„ìŠ¤'}`);
            if (phone) filterDesc.push(`ì „í™”ë²ˆí˜¸: ${phone}`);
            
            // í•„í„°ë§ëœ KPI ì—…ë°ì´íŠ¸
            updateFilteredKPI(result.kpi, filterDesc.join(', '));
            
            // ê²€ìƒ‰ ê²°ê³¼ í‘œì‹œ
            displaySearchResults(result.data, `ê³ ê¸‰í•„í„°: ${filterDesc.join(', ')}`);
            
            showSearchStatus(`âœ… í•„í„° ì™„ë£Œ: ${result.total}ê±´`, 'success');
            
        } catch (error) {
            showSearchStatus(`âŒ í•„í„° ì‹¤íŒ¨: ${error.message}`, 'error');
        }
    }

    // í•„í„°ë§ëœ ë°ì´í„° KPI ì—…ë°ì´íŠ¸
    function updateFilteredKPI(kpi, description) {
        document.getElementById('filtered-total-cost').textContent = formatCurrency(kpi.totalCost);
        document.getElementById('filtered-active-lines').textContent = `${kpi.activeLines} ê°œ`;
        document.getElementById('filtered-avg-cost').textContent = formatCurrency(kpi.avgCost);
        document.getElementById('filtered-basic-lines').textContent = `${kpi.basicFeeOnlyLines} ê°œ`;
        document.getElementById('filtered-vas-fee').textContent = formatCurrency(kpi.totalVasFee);
        
        // KPI ì„¹ì…˜ í‘œì‹œ
        const section = document.getElementById('filtered-kpi-section');
        section.style.display = 'block';
        
        // ì œëª©ì— ì„¤ëª… ì¶”ê°€
        const title = document.getElementById('kpi-title');
        title.textContent = `ğŸ“Š í•„í„°ë§ëœ ë°ì´í„° í†µê³„ (${description})`;
    }

    // ê²€ìƒ‰ ê²°ê³¼ í‘œì‹œ
    function displaySearchResults(data, title) {
        const section = document.getElementById('filtered-data-section');
        const tbody = document.querySelector('#filtered-data-table tbody');
        const countSpan = document.getElementById('data-count');
        const titleSpan = document.getElementById('table-title');
        
        tbody.innerHTML = '';
        countSpan.textContent = `(${data.length}ê±´)`;
        titleSpan.textContent = title;
        
        data.forEach(row => {
            const tr = tbody.insertRow();
            tr.insertCell(0).textContent = row.ì²­êµ¬ì›”;
            tr.insertCell(1).textContent = row.ì§€ì ëª…;
            tr.insertCell(2).textContent = row.ì „í™”ë²ˆí˜¸;
            
            if (isDetailedView) {
                tr.insertCell(3).textContent = formatCurrency(row.ê¸°ë³¸ë£Œ);
                tr.insertCell(4).textContent = formatCurrency(row.ì‹œë‚´í†µí™”ë£Œ);
                tr.insertCell(5).textContent = formatCurrency(row.ì´ë™í†µí™”ë£Œ);
                tr.insertCell(6).textContent = formatCurrency(row['070í†µí™”ë£Œ']);
                tr.insertCell(7).textContent = formatCurrency(row.ë¶€ê°€ì„œë¹„ìŠ¤ë£Œ);
                tr.insertCell(8).textContent = formatCurrency(row.ìµœì¢…í•©ê³„);
            } else {
                tr.insertCell(3).textContent = formatCurrency(row.ìµœì¢…í•©ê³„);
            }
        });
        
        section.style.display = 'block';
        document.getElementById('export-btn').style.display = 'inline-block';
        section.scrollIntoView({ behavior: 'smooth' });
    }

    // í…Œì´ë¸” ë³´ê¸° í† ê¸€
    function toggleTableView() {
        isDetailedView = !isDetailedView;
        const toggleBtn = document.getElementById('toggle-btn');
        const headerRow = document.getElementById('table-header');
        
        if (isDetailedView) {
            toggleBtn.textContent = 'ê°„ë‹¨íˆ ë³´ê¸°';
            headerRow.innerHTML = `
                <th>ì²­êµ¬ì›”</th>
                <th>ì§€ì ëª…</th>
                <th>ì „í™”ë²ˆí˜¸</th>
                <th>ê¸°ë³¸ë£Œ</th>
                <th>ì‹œë‚´í†µí™”ë£Œ</th>
                <th>ì´ë™í†µí™”ë£Œ</th>
                <th>070í†µí™”ë£Œ</th>
                <th>ë¶€ê°€ì„œë¹„ìŠ¤ë£Œ</th>
                <th>ìµœì¢…í•©ê³„</th>
            `;
        } else {
            toggleBtn.textContent = 'ìƒì„¸íˆ ë³´ê¸°';
            headerRow.innerHTML = `
                <th>ì²­êµ¬ì›”</th>
                <th>ì§€ì ëª…</th>
                <th>ì „í™”ë²ˆí˜¸</th>
                <th>ìµœì¢…í•©ê³„</th>
            `;
        }
        
        // ê¸°ì¡´ ê²€ìƒ‰ ê²°ê³¼ ë‹¤ì‹œ í‘œì‹œ
        if (lastSearchResult) {
            const titleElement = document.getElementById('table-title');
            const currentTitle = titleElement.textContent;
            displaySearchResults(lastSearchResult.data, currentTitle);
        }
    }

    // ì „ì²´ ì´ˆê¸°í™”
    function resetAllFilters() {
        document.getElementById('unified-search').value = '';
        document.getElementById('branch-filter').value = 'all';
        document.getElementById('month-filter').value = 'all';
        document.getElementById('type-filter').value = 'all';
        document.getElementById('phone-search').value = '';
        
        // KPI ì„¹ì…˜ ìˆ¨ê¸°ê¸°
        document.getElementById('filtered-kpi-section').style.display = 'none';
        document.getElementById('filtered-data-section').style.display = 'none';
        document.getElementById('export-btn').style.display = 'none';
        
        lastSearchResult = null;
        showSearchStatus('í•„í„°ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
    }

    // ê²€ìƒ‰ ìƒíƒœ í‘œì‹œ
    function showSearchStatus(message, type) {
        const statusDiv = document.getElementById('search-status');
        statusDiv.textContent = message;
        statusDiv.className = type;
    }

    // í•„í„°ëœ ê²°ê³¼ Excel ë‚´ë³´ë‚´ê¸°
    async function exportFilteredExcel() {
        if (!lastSearchResult || !lastSearchResult.data.length) {
            alert('ë‚´ë³´ë‚¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }
        
        try {
            showSearchStatus('Excel íŒŒì¼ ìƒì„± ì¤‘...', 'loading');
            
            // í˜„ì¬ í•„í„° ì¡°ê±´ì„ ì„œë²„ì— ì „ì†¡
            const params = new URLSearchParams();
            const branch = document.getElementById('branch-filter').value;
            const month = document.getElementById('month-filter').value;
            const type = document.getElementById('type-filter').value;
            const phone = document.getElementById('phone-search').value.trim();
            const search = document.getElementById('unified-search').value.trim();
            
            if (branch !== 'all') params.append('branch', branch);
            if (month !== 'all') params.append('month', month);
            if (type !== 'all') params.append('type', type);
            if (phone) params.append('phone', phone);
            if (search) params.append('q', search);
            
            const response = await fetch(`${API_BASE}/api/export/excel-filtered?${params.toString()}`);
            
            if (!response.ok) {
                throw new Error('Excel ë‚´ë³´ë‚´ê¸° ì‹¤íŒ¨');
            }
            
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `í•„í„°_ê²€ìƒ‰ê²°ê³¼_${new Date().toISOString().slice(0,10)}.xlsx`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            
            showSearchStatus('âœ… Excel íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ!', 'success');
            
        } catch (error) {
            showSearchStatus(`âŒ Excel ë‚´ë³´ë‚´ê¸° ì‹¤íŒ¨: ${error.message}`, 'error');
        }
    }
</script>
{% endblock %}