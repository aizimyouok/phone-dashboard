{% extends "base.html" %}

{% block title %}ë¶„ì„ ë¦¬í¬íŠ¸ - ì „í™”ìš”ê¸ˆ ê´€ë¦¬ ì‹œìŠ¤í…œ{% endblock %}

{% block extra_css %}
<style>
    .analysis-grid {
        display: grid;
        gap: 30px;
        margin-bottom: 30px;
    }
    
    .analysis-card {
        background: white;
        padding: 25px;
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        transition: transform 0.3s;
    }
    
    .analysis-card:hover {
        transform: translateY(-5px);
    }
    
    .analysis-card h3 {
        margin: 0 0 20px 0;
        color: #333;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .trend-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
        margin-bottom: 10px;
    }
    
    .trend-up { color: #dc3545; }
    .trend-down { color: #28a745; }
    .trend-stable { color: #6c757d; }
    
    .alert-item {
        padding: 15px;
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 8px;
        margin-bottom: 10px;
        border-left: 4px solid #f39c12;
    }
    
    .suggestion-item {
        padding: 15px;
        background: #d1ecf1;
        border: 1px solid #bee5eb;
        border-radius: 8px;
        margin-bottom: 10px;
        border-left: 4px solid #17a2b8;
    }
    
    .chart-controls {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }
    
    .metric-badge {
        background: #667eea;
        color: white;
        padding: 5px 10px;
        border-radius: 15px;
        font-size: 12px;
        font-weight: bold;
    }
    
    .branch-report-card {
        border: 1px solid #dee2e6;
        border-radius: 10px;
        margin-bottom: 20px;
        overflow: hidden;
    }
    
    .branch-report-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px 20px;
        font-weight: bold;
    }
    
    .branch-report-body {
        padding: 20px;
    }
    
    .loading-spinner {
        display: none;
        text-align: center;
        padding: 20px;
        color: #666;
    }
</style>
{% endblock %}

{% block content %}
    <!-- ë¶„ì„ ë¦¬í¬íŠ¸ í—¤ë” -->
    <section class="controls">
        <h3>ğŸ“Š ë¶„ì„ ë¦¬í¬íŠ¸ ëŒ€ì‹œë³´ë“œ</h3>
        <div class="filter-row">
            <div class="filter-group">
                <label>ë¶„ì„ ê¸°ê°„</label>
                <select id="analysis-period">
                    <option value="3">ìµœê·¼ 3ê°œì›”</option>
                    <option value="6">ìµœê·¼ 6ê°œì›”</option>
                    <option value="12">ìµœê·¼ 12ê°œì›”</option>
                </select>
            </div>
            <div class="filter-group">
                <label>ë¶„ì„ ëŒ€ìƒ ì§€ì </label>
                <select id="analysis-branch">
                    <option value="all">ì „ì²´ ì§€ì </option>
                </select>
            </div>
            <button class="btn btn-primary" onclick="loadAnalysisData()">ğŸ“Š ë¶„ì„ ì—…ë°ì´íŠ¸</button>
            <button class="btn btn-success" onclick="generateMonthlyReport()">ğŸ“‹ ì›”ê°„ ë¦¬í¬íŠ¸ ìƒì„±</button>
        </div>
        <div id="analysis-status" style="margin-top: 10px;"></div>
    </section>

    <!-- ë¶„ì„ ê²°ê³¼ -->
    <div class="analysis-grid">
        <!-- 1. ì›”ë³„ ë¹„êµ ì°¨íŠ¸ -->
        <div class="analysis-card">
            <h3>ğŸ“ˆ ì›”ë³„ ìš”ê¸ˆ ë¹„êµ ë¶„ì„</h3>
            <div class="chart-controls">
                <button class="btn btn-secondary" onclick="updateComparisonChart('total')">ì´ ìš”ê¸ˆ</button>
                <button class="btn btn-secondary" onclick="updateComparisonChart('average')">í‰ê·  ìš”ê¸ˆ</button>
                <button class="btn btn-secondary" onclick="updateComparisonChart('lines')">íšŒì„  ìˆ˜</button>
            </div>
            <div style="position: relative; height: 300px;">
                <canvas id="comparisonChart"></canvas>
            </div>
            <div id="comparison-summary" style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                <div class="loading-spinner">ë°ì´í„° ë¡œë”© ì¤‘...</div>
            </div>
        </div>

        <!-- 2. ì§€ì ë³„ íŠ¸ë Œë“œ ë¶„ì„ -->
        <div class="analysis-card">
            <h3>ğŸ“Š ì§€ì ë³„ íŠ¸ë Œë“œ ë¶„ì„</h3>
            <div id="trend-analysis">
                <div class="loading-spinner">íŠ¸ë Œë“œ ë¶„ì„ ì¤‘...</div>
            </div>
        </div>

        <!-- 3. ì´ìƒ ì‚¬ìš© ê°ì§€ -->
        <div class="analysis-card">
            <h3>ğŸš¨ ì´ìƒ ì‚¬ìš© ê°ì§€</h3>
            <div id="anomaly-detection">
                <div class="loading-spinner">ì´ìƒ íŒ¨í„´ ë¶„ì„ ì¤‘...</div>
            </div>
        </div>

        <!-- 4. ë¹„ìš© ì ˆê° ì œì•ˆ -->
        <div class="analysis-card">
            <h3>ğŸ’¡ ë¹„ìš© ì ˆê° ì œì•ˆ</h3>
            <div id="cost-saving-suggestions">
                <div class="loading-spinner">ì ˆê° ë°©ì•ˆ ë¶„ì„ ì¤‘...</div>
            </div>
        </div>
    </div>

    <!-- ì§€ì ë³„ ìƒì„¸ ë¦¬í¬íŠ¸ -->
    <section class="analysis-card">
        <h3>ğŸ¢ ì§€ì ë³„ ìƒì„¸ ë¦¬í¬íŠ¸</h3>
        <div class="chart-controls">
            <select id="detailed-branch-select">
                <option value="all">ì „ì²´ ì§€ì  ë³´ê¸°</option>
            </select>
            <button class="btn btn-primary" onclick="loadBranchDetails()">ìƒì„¸ ë¶„ì„</button>
            <button class="btn btn-success" onclick="exportBranchReport()">ì§€ì  ë¦¬í¬íŠ¸ ë‹¤ìš´ë¡œë“œ</button>
        </div>
        <div id="branch-details">
            <div class="loading-spinner">ì§€ì ë³„ ë°ì´í„° ë¡œë”© ì¤‘...</div>
        </div>
    </section>

    <!-- ë¦¬í¬íŠ¸ ìƒì„± ê²°ê³¼ -->
    <div id="report-result" style="display: none; margin-top: 20px;"></div>
{% endblock %}

{% block extra_js %}
<script>
    let comparisonChart = null;
    let currentAnalysisData = null;

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
    document.addEventListener('DOMContentLoaded', function() {
        loadBranchOptions();
        loadAnalysisData();
    });

    // ì§€ì  ì˜µì…˜ ë¡œë“œ
    async function loadBranchOptions() {
        try {
            const response = await fetch(`${API_BASE}/api/branches`);
            const branches = await response.json();
            
            // ë¶„ì„ ëŒ€ìƒ ì§€ì  ì„ íƒ
            const analysisSelect = document.getElementById('analysis-branch');
            analysisSelect.innerHTML = '<option value="all">ì „ì²´ ì§€ì </option>';
            
            // ìƒì„¸ ì§€ì  ì„ íƒ
            const detailSelect = document.getElementById('detailed-branch-select');
            detailSelect.innerHTML = '<option value="all">ì „ì²´ ì§€ì  ë³´ê¸°</option>';
            
            branches.forEach(branch => {
                const option1 = document.createElement('option');
                option1.value = branch;
                option1.textContent = branch;
                analysisSelect.appendChild(option1);
                
                const option2 = document.createElement('option');
                option2.value = branch;
                option2.textContent = branch;
                detailSelect.appendChild(option2);
            });
            
        } catch (error) {
            console.error('ì§€ì  ì˜µì…˜ ë¡œë“œ ì‹¤íŒ¨:', error);
        }
    }

    // ë¶„ì„ ë°ì´í„° ë¡œë“œ
    async function loadAnalysisData() {
        const period = document.getElementById('analysis-period').value;
        const branch = document.getElementById('analysis-branch').value;
        
        showAnalysisStatus('ë¶„ì„ ë°ì´í„° ë¡œë”© ì¤‘...', 'loading');
        
        try {
            const params = new URLSearchParams({
                period: period,
                branch: branch
            });
            
            const response = await fetch(`${API_BASE}/api/analytics/comprehensive?${params}`);
            const data = await response.json();
            
            if (data.error) {
                showAnalysisStatus(`âŒ ${data.error}`, 'error');
                return;
            }
            
            currentAnalysisData = data;
            
            // ê° ë¶„ì„ ê²°ê³¼ ì—…ë°ì´íŠ¸
            updateComparisonChart('total');
            updateTrendAnalysis(data.trends);
            updateAnomalyDetection(data.anomalies);
            updateCostSavingSuggestions(data.suggestions);
            
            showAnalysisStatus('âœ… ë¶„ì„ ì™„ë£Œ!', 'success');
            
        } catch (error) {
            showAnalysisStatus(`âŒ ë¶„ì„ ì‹¤íŒ¨: ${error.message}`, 'error');
        }
    }

    // ì›”ë³„ ë¹„êµ ì°¨íŠ¸ ì—…ë°ì´íŠ¸
    function updateComparisonChart(metric = 'total') {
        if (!currentAnalysisData || !currentAnalysisData.monthlyComparison) {
            return;
        }
        
        const ctx = document.getElementById('comparisonChart').getContext('2d');
        const data = currentAnalysisData.monthlyComparison;
        
        if (comparisonChart) {
            comparisonChart.destroy();
        }
        
        let chartData, label, summary;
        
        switch(metric) {
            case 'total':
                chartData = data.totalCosts;
                label = 'ì´ ìš”ê¸ˆ (ì›)';
                summary = generateComparisonSummary(data.totalCosts, 'ì´ ìš”ê¸ˆ');
                break;
            case 'average':
                chartData = data.averageCosts;
                label = 'í‰ê·  ìš”ê¸ˆ (ì›)';
                summary = generateComparisonSummary(data.averageCosts, 'í‰ê·  ìš”ê¸ˆ');
                break;
            case 'lines':
                chartData = data.lineCounts;
                label = 'íšŒì„  ìˆ˜ (ê°œ)';
                summary = generateComparisonSummary(data.lineCounts, 'íšŒì„  ìˆ˜');
                break;
        }
        
        comparisonChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.months,
                datasets: [{
                    label: label,
                    data: chartData,
                    borderColor: '#667eea',
                    backgroundColor: 'rgba(102, 126, 234, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return metric === 'lines' ? value + 'ê°œ' : formatNumber(value) + 'ì›';
                            }
                        }
                    }
                }
            }
        });
        
        // ìš”ì•½ ì •ë³´ ì—…ë°ì´íŠ¸
        document.getElementById('comparison-summary').innerHTML = summary;
    }

    // ë¹„êµ ìš”ì•½ ìƒì„±
    function generateComparisonSummary(data, type) {
        if (data.length < 2) return '<p>ë¹„êµí•  ë°ì´í„°ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.</p>';
        
        const latest = data[data.length - 1];
        const previous = data[data.length - 2];
        const change = latest - previous;
        const changePercent = ((change / previous) * 100).toFixed(1);
        
        const trendClass = change > 0 ? 'trend-up' : change < 0 ? 'trend-down' : 'trend-stable';
        const trendIcon = change > 0 ? 'ğŸ“ˆ' : change < 0 ? 'ğŸ“‰' : 'â¡ï¸';
        const trendText = change > 0 ? 'ì¦ê°€' : change < 0 ? 'ê°ì†Œ' : 'ë³€í™”ì—†ìŒ';
        
        return `
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <strong>ì „ì›” ëŒ€ë¹„ ${type} ${trendText}</strong>
                    <div class="${trendClass}">
                        ${trendIcon} ${Math.abs(changePercent)}% (${formatNumber(Math.abs(change))}${type.includes('íšŒì„ ') ? 'ê°œ' : 'ì›'})
                    </div>
                </div>
                <div class="metric-badge">
                    í˜„ì¬: ${formatNumber(latest)}${type.includes('íšŒì„ ') ? 'ê°œ' : 'ì›'}
                </div>
            </div>
        `;
    }

    // íŠ¸ë Œë“œ ë¶„ì„ ì—…ë°ì´íŠ¸
    function updateTrendAnalysis(trends) {
        const container = document.getElementById('trend-analysis');
        
        if (!trends || trends.length === 0) {
            container.innerHTML = '<p>íŠ¸ë Œë“œ ë¶„ì„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
            return;
        }
        
        let html = '';
        trends.forEach(trend => {
            const trendClass = trend.direction === 'up' ? 'trend-up' : 
                              trend.direction === 'down' ? 'trend-down' : 'trend-stable';
            const trendIcon = trend.direction === 'up' ? 'ğŸ“ˆ' : 
                             trend.direction === 'down' ? 'ğŸ“‰' : 'â¡ï¸';
            
            html += `
                <div class="trend-item">
                    <div>
                        <strong>${trend.branch}</strong>
                        <div style="font-size: 14px; color: #666;">
                            ${trend.period} ì¶”ì„¸: ${trend.description}
                        </div>
                    </div>
                    <div class="${trendClass}">
                        ${trendIcon} ${trend.changePercent}%
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
    }

    // ì´ìƒ ì‚¬ìš© ê°ì§€ ì—…ë°ì´íŠ¸
    function updateAnomalyDetection(anomalies) {
        const container = document.getElementById('anomaly-detection');
        
        if (!anomalies || anomalies.length === 0) {
            container.innerHTML = '<p style="color: #28a745;">âœ… ì´ìƒ ì‚¬ìš©ì´ ê°ì§€ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</p>';
            return;
        }
        
        let html = '';
        anomalies.forEach(anomaly => {
            html += `
                <div class="alert-item">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong>ğŸš¨ ${anomaly.branch} - ${anomaly.phone}</strong>
                            <div style="font-size: 14px; color: #666; margin-top: 5px;">
                                ${anomaly.description}
                            </div>
                        </div>
                        <div class="metric-badge" style="background: #dc3545;">
                            +${anomaly.increasePercent}%
                        </div>
                    </div>
                    <div style="margin-top: 10px; font-size: 14px;">
                        ì´ì „ í‰ê· : ${formatCurrency(anomaly.previousAverage)} â†’ 
                        í˜„ì¬: ${formatCurrency(anomaly.currentAmount)}
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
    }

    // ë¹„ìš© ì ˆê° ì œì•ˆ ì—…ë°ì´íŠ¸
    function updateCostSavingSuggestions(suggestions) {
        const container = document.getElementById('cost-saving-suggestions');
        
        if (!suggestions || suggestions.length === 0) {
            container.innerHTML = '<p>í˜„ì¬ ì¶”ê°€ ì ˆê° ë°©ì•ˆì´ ì—†ìŠµë‹ˆë‹¤.</p>';
            return;
        }
        
        let html = '';
        let totalSavings = 0;
        
        suggestions.forEach(suggestion => {
            totalSavings += suggestion.potentialSavings;
            html += `
                <div class="suggestion-item">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong>ğŸ’¡ ${suggestion.title}</strong>
                            <div style="font-size: 14px; color: #666; margin-top: 5px;">
                                ${suggestion.description}
                            </div>
                        </div>
                        <div class="metric-badge" style="background: #17a2b8;">
                            ì›” ${formatCurrency(suggestion.potentialSavings)} ì ˆê°
                        </div>
                    </div>
                    <div style="margin-top: 10px; font-size: 14px;">
                        ëŒ€ìƒ: ${suggestion.targetCount}ê°œ íšŒì„  | ìš°ì„ ìˆœìœ„: ${suggestion.priority}
                    </div>
                </div>
            `;
        });
        
        // ì´ ì ˆê° ê°€ëŠ¥ ê¸ˆì•¡ í‘œì‹œ
        html = `
            <div style="background: #d4edda; padding: 15px; border-radius: 8px; margin-bottom: 15px; text-align: center;">
                <strong>ğŸ’° ì´ ì ˆê° ê°€ëŠ¥ ê¸ˆì•¡: ${formatCurrency(totalSavings)}/ì›”</strong>
                <div style="font-size: 14px; color: #666;">ì—°ê°„ ì•½ ${formatCurrency(totalSavings * 12)} ì ˆê° ê°€ëŠ¥</div>
            </div>
        ` + html;
        
        container.innerHTML = html;
    }

    // ì§€ì ë³„ ìƒì„¸ ë¶„ì„ ë¡œë“œ
    async function loadBranchDetails() {
        const branch = document.getElementById('detailed-branch-select').value;
        const container = document.getElementById('branch-details');
        
        container.innerHTML = '<div class="loading-spinner">ì§€ì ë³„ ìƒì„¸ ë¶„ì„ ì¤‘...</div>';
        
        try {
            const params = new URLSearchParams({ branch: branch });
            const response = await fetch(`${API_BASE}/api/analytics/branch-details?${params}`);
            const data = await response.json();
            
            if (data.error) {
                container.innerHTML = `<p class="error">âŒ ${data.error}</p>`;
                return;
            }
            
            let html = '';
            
            if (branch === 'all') {
                // ì „ì²´ ì§€ì  ìš”ì•½
                data.branches.forEach(branchData => {
                    html += generateBranchCard(branchData);
                });
            } else {
                // íŠ¹ì • ì§€ì  ìƒì„¸
                html = generateDetailedBranchReport(data);
            }
            
            container.innerHTML = html;
            
        } catch (error) {
            container.innerHTML = `<p class="error">âŒ ìƒì„¸ ë¶„ì„ ì‹¤íŒ¨: ${error.message}</p>`;
        }
    }

    // ì§€ì  ì¹´ë“œ ìƒì„±
    function generateBranchCard(branchData) {
        return `
            <div class="branch-report-card">
                <div class="branch-report-header">
                    ğŸ¢ ${branchData.name}
                </div>
                <div class="branch-report-body">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                        <div class="kpi-card" style="margin: 0;">
                            <div class="title">ì´ ìš”ê¸ˆ</div>
                            <div class="value" style="font-size: 20px;">${formatCurrency(branchData.totalCost)}</div>
                        </div>
                        <div class="kpi-card" style="margin: 0;">
                            <div class="title">íšŒì„  ìˆ˜</div>
                            <div class="value" style="font-size: 20px;">${branchData.lineCount}ê°œ</div>
                        </div>
                        <div class="kpi-card" style="margin: 0;">
                            <div class="title">í‰ê·  ìš”ê¸ˆ</div>
                            <div class="value" style="font-size: 20px;">${formatCurrency(branchData.averageCost)}</div>
                        </div>
                        <div class="kpi-card" style="margin: 0;">
                            <div class="title">ì „ì›” ëŒ€ë¹„</div>
                            <div class="value trend-${branchData.trend.direction}" style="font-size: 16px;">
                                ${branchData.trend.direction === 'up' ? 'ğŸ“ˆ' : branchData.trend.direction === 'down' ? 'ğŸ“‰' : 'â¡ï¸'} 
                                ${branchData.trend.changePercent}%
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    // ìƒì„¸ ì§€ì  ë¦¬í¬íŠ¸ ìƒì„±
    function generateDetailedBranchReport(data) {
        return `
            <div class="branch-report-card">
                <div class="branch-report-header">
                    ğŸ¢ ${data.branchName} ìƒì„¸ ë¶„ì„ ë¦¬í¬íŠ¸
                </div>
                <div class="branch-report-body">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                        <div>
                            <h4>ğŸ“Š ê¸°ë³¸ í†µê³„</h4>
                            <div class="trend-item">
                                <span>ì´ íšŒì„  ìˆ˜</span>
                                <span>${data.totalLines}ê°œ</span>
                            </div>
                            <div class="trend-item">
                                <span>ì›” í‰ê·  ìš”ê¸ˆ</span>
                                <span>${formatCurrency(data.monthlyAverage)}</span>
                            </div>
                            <div class="trend-item">
                                <span>ìµœê³  ì‚¬ìš© ì›”</span>
                                <span>${data.peakMonth} (${formatCurrency(data.peakAmount)})</span>
                            </div>
                            <div class="trend-item">
                                <span>ê¸°ë³¸ë£Œë§Œ ë°œìƒ íšŒì„ </span>
                                <span>${data.basicOnlyLines}ê°œ</span>
                            </div>
                        </div>
                        <div>
                            <h4>ğŸ“ íšŒì„ ë³„ ìƒì„¸</h4>
                            <div style="max-height: 300px; overflow-y: auto;">
                                ${data.phoneDetails.map(phone => `
                                    <div class="trend-item" style="font-size: 14px;">
                                        <span>${phone.number}</span>
                                        <span>${formatCurrency(phone.averageCost)}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    // ì›”ê°„ ë¦¬í¬íŠ¸ ìƒì„±
    async function generateMonthlyReport() {
        showAnalysisStatus('ì›”ê°„ ë¦¬í¬íŠ¸ ìƒì„± ì¤‘...', 'loading');
        
        try {
            const period = document.getElementById('analysis-period').value;
            const branch = document.getElementById('analysis-branch').value;
            
            const params = new URLSearchParams({
                period: period,
                branch: branch,
                format: 'pdf'
            });
            
            const response = await fetch(`${API_BASE}/api/analytics/monthly-report?${params}`);
            
            if (!response.ok) {
                throw new Error('ë¦¬í¬íŠ¸ ìƒì„± ì‹¤íŒ¨');
            }
            
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ì›”ê°„_ë¶„ì„_ë¦¬í¬íŠ¸_${new Date().toISOString().slice(0,10)}.pdf`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            
            showAnalysisStatus('âœ… ì›”ê°„ ë¦¬í¬íŠ¸ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ!', 'success');
            
        } catch (error) {
            showAnalysisStatus(`âŒ ë¦¬í¬íŠ¸ ìƒì„± ì‹¤íŒ¨: ${error.message}`, 'error');
        }
    }

    // ì§€ì  ë¦¬í¬íŠ¸ ë‚´ë³´ë‚´ê¸°
    async function exportBranchReport() {
        const branch = document.getElementById('detailed-branch-select').value;
        
        if (branch === 'all') {
            alert('íŠ¹ì • ì§€ì ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
            return;
        }
        
        try {
            showAnalysisStatus('ì§€ì  ë¦¬í¬íŠ¸ ìƒì„± ì¤‘...', 'loading');
            
            const params = new URLSearchParams({ branch: branch });
            const response = await fetch(`${API_BASE}/api/analytics/branch-report?${params}`);
            
            if (!response.ok) {
                throw new Error('ì§€ì  ë¦¬í¬íŠ¸ ìƒì„± ì‹¤íŒ¨');
            }
            
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${branch}_ìƒì„¸ë¦¬í¬íŠ¸_${new Date().toISOString().slice(0,10)}.xlsx`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            
            showAnalysisStatus('âœ… ì§€ì  ë¦¬í¬íŠ¸ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ!', 'success');
            
        } catch (error) {
            showAnalysisStatus(`âŒ ì§€ì  ë¦¬í¬íŠ¸ ìƒì„± ì‹¤íŒ¨: ${error.message}`, 'error');
        }
    }

    // ë¶„ì„ ìƒíƒœ í‘œì‹œ
    function showAnalysisStatus(message, type) {
        const statusDiv = document.getElementById('analysis-status');
        statusDiv.textContent = message;
        statusDiv.className = type;
    }
</script>
{% endblock %}